# 分析コーディネーター仕様書

## 概要
step3_analyze.py が実行する分析サイクルの仕様。

## 分析の最上位目的
**伸びた動画の共通点と伸びていない動画の共通点を明らかにし、「伸びる動画の黄金理論」を構築すること。**

### 中心的な問い（全分析はここから派生する）
1. **伸びた動画（15万回再生以上）全てに共通することは何か？**
2. **伸びていない動画（15万回再生未満）全てに共通することは何か？**
3. **1と2から導き出せる「伸びる動画の黄金理論」は何か？**

仮説はすべてこの3つの問いへの回答として設計すること。無関係な仮説は立てない。

### 分析手法（三本柱）
1. **水平思考**: 前提列挙→前提反転→代替説生成のフレームワークをAgent Cの分析フローに組み込む
2. **第一原理主義**: `prompts/youtube_fundamentals.md` に明文化された前提知識から演繹的に考える
3. **仮説駆動アプローチ**: McKinsey方式の「答えから始める」手法。中心的な問いからDay 1 Answerを設定し、検証→進化させる

### Agent間の役割分担
- **Agent C（メタ分析）**: 共通点抽出 → 前提列挙 → 水平思考 → 因果仮説生成 → 仮説提示
- **Agent E（検証）**: レッドチームとしてAgent Cの仮説を反証データで検証。確証バイアス防止が主任務

### HIT/MISSの定義
- **HIT**: 15万回再生以上
- **MISS**: 15万回再生未満

### 黄金理論の形式
黄金理論は二層構造で構築する:

**第1層: 上位原則（なぜ伸びるのか）**
- YouTubeアルゴリズム・視聴者心理から演繹した「伸びるメカニズム」の説明
- 例: 「〇〇が△△を引き起こし、結果として再生数が伸びる」

**第2層: 実用チェックリスト（制作前に確認できる条件）**
- 制作者がコントロール可能な具体的条件のリスト
- 各条件にHIT群での充足率とMISS群での充足率を付記
- 例: 「条件X: HIT群 90%充足 / MISS群 20%充足」

### 分析に使用するデータの3分類

#### アナリティクスデータ（YouTube API + Studioから取得）
| カテゴリ | 指標 | 取得元 |
|---------|------|--------|
| 基本指標 | 再生数, いいね数, コメント数, シェア数, 登録者獲得数 | API |
| トラフィック（7日合算） | ブラウジングIMP/CTR/視聴数, 関連動画IMP/CTR/視聴数, 検索IMP/CTR, 登録者視聴数 | Studio CSV |
| トラフィック（日別） | Day1-7のトラフィックソース別視聴数・CTR | API（day×trafficSource クロス集計） |
| 視聴維持 | 平均視聴時間(秒), 平均視聴率(%) | API |
| デモグラフィック | 年齢層別%, 性別%, コアターゲット(45-64歳)比率 | API |
| 日別推移 | Day1-7再生数, Day1→Day2変化率(%), 成長パターン分類 | API |
| 視聴者セグメント | コア視聴者%, ライト視聴者%, 新規視聴者% | Studio CSV |
| 関連動画ソース（※新規） | この動画への流入元となった関連動画のID・タイトル・視聴数・IMP・CTR（7日合算） | API（insightTrafficSourceDetail） |

#### 台本データ（台本構造分析JSONから取得）
| カテゴリ | 指標 | 形式 |
|---------|------|------|
| 構造 | 一言テーマ有無, 敵役有無, 感情の底の数, エスカレーション有無, 救世主有無, 4要素完備フラグ | bool/num |
| フック | オープニング質問, 回答有無, 回答位置(%) | str/bool/num |
| MV | MV挿入数, 曲名リスト, 重要シーン配置フラグ | num/list/bool |
| 好奇心一致 | TOP1トピック, TOP1回答有無, TOP2トピック, TOP2回答有無, CAスコア(0-3) | str/bool/num |
| 感情曲線 | アップの数, ダウンの数, 合計転換数, 幕別パターン(Intro/1幕/2幕/3幕) | num/str |
| 導入30秒 | 開始タイプ(衝撃事実型/問いかけ型/エピソード導入型/データ提示型等), 引きの強さ(1-5) | str/num |
| 本人映像 | MV以外のYouTubeリンク総数, 種類分類(インタビュー/ライブ/ドキュメンタリー等) | num/list |
| 文字数 | 総文字数 | num |

#### メタデータ（定量評価・コンテキスト情報）
| カテゴリ | 指標 | 形式 | 採点基準 |
|---------|------|------|---------|
| GI評価 | G1(ゴシップ), G2(好奇心), G3(感情), G4(映画化), G6(楽曲知名度), GI_v3合計 | num(各1-5) | `prompts/scoring_criteria.md`の定量基準 |
| CA評価 | CAスコア(0-3), GI×CA | num | TOP1-2核心KWとタイトルのキーワード照合 |
| 好奇心TOP1-2 | Web検索由来のトピック + 核心キーワード | str | 5検索クエリの出現頻度順 |
| エビデンス | G{N}_evidence, CA_evidence, curiosity_search_date | str | 検索クエリ・件数・照合結果 |
| コンテキスト | 公開日, 公開曜日, 公開時登録者数, 時事性（関連イベントの有無） | date/num/str | - |

> **スコアリングプロセス**: GI/CAの採点は`prompts/scoring_criteria.md`の定量基準に従う。主観判断は禁止。
> source="quantitative"（定量基準準拠）、source="human"（旧方式）、source="ai_calibrated"（AI推定、予測使用禁止）

### 重点的に見るべきデータ範囲

1. **最初の24時間（Day1）**: 最重要。ブラウジング推薦の初動を決定する
   - Day1の再生数、トラフィックソース別内訳（ブラウジング/関連/検索/登録者）
   - Day1のCTR

2. **最初の7日間（Day1-7）**: ほとんどの動画はここで伸びるかどうかが決まる
   - 日別推移パターン（成長型/減衰型/安定型）
   - Day1→Day2変化率（フック詐欺の検出: -50%以下で警告）
   - トラフィックソースの推移（ブラウジング比率の変化）

3. **遅延HIT（7日後に伸び始めた動画）**: 特殊ケースだが重要
   - 対象候補: ジャスティンビーバー（D1-7で8%、92%が7日後）、フレディーマーキュリー（D1→D7で631%成長）
   - 分析範囲: 視聴回数が急増したポイントまで拡張する
   - 遅延HIT発生時のトラフィックソース変化（何がトリガーになったか）を特定する

## 必読ファイル（分析開始前に必ず読むこと）

1. **`data/input/analysis_fundamentals.json`** — 分析の不変基盤。目的・定義・指標・方法論の全てがここに定義されている。この内容に反する分析は無効とする。
2. `data/output/golden_theory.json` — 現在の黄金理論（変動する知見の蓄積）
3. `data/history/insights.md` — 過去の仮説・検証結果の履歴

## サイクルフロー
```
Phase 1: データ準備
  1. data_summarizer.py 実行 → data/workspace/data_summary.md 生成
```

## Phase 2: 仮説生成→検証ループ（最大5サイクル）

### サイクルの実行手順
1. `python scripts/step3_analyze.py` でデータ準備（Step 3）
2. Claude Code で Agent C を実行 → `workspace/new_hypotheses.md` 生成（Step 4）
3. Claude Code で Agent E を実行 → `workspace/verification_report.md` 生成（Step 5）
4. `python scripts/step3_analyze.py --integrate` で統合処理（Step 6）
   - Agent出力のJSONブロックをパース
   - insights.md を更新（採択/棄却/学びを追記）
   - golden_theory.json を更新（チェックリスト追加/棄却移動）
   - step2_build_model.py を実行（モデル再構築）
5. 矛盾チェック:
   - `unresolved_contradictions` が空 → 完了
   - 残存あり & サイクル < 5 → 手順1に戻る
   - 残存あり & サイクル = 5 → 強制終了。残存矛盾を `insights.md` に記録

### サイクル間の情報引き継ぎ
- Agent C は次サイクルで `insights.md` を読むことで、前サイクルの棄却仮説と学びを知る
- `insights.md` の「## 棄却仮説と学び」セクションに前サイクルの棄却理由が記録されている
- Agent C は棄却された仮説と同じ仮説を再生成してはならない（insights.mdで確認すること）
- `insights.md` の「## 探索的発見」セクションに、次サイクルへの手がかりが記録されている

### サイクルの終了条件
- **正常終了**: 全仮説が「支持」or「修正」で、未解決矛盾がゼロ
- **成果ありで終了**: 一部採択・一部棄却だが、新たな手がかりがない
- **上限終了**: 5サイクル到達。残存矛盾を記録して終了

```
Phase 3: 知見の蓄積（step2 --integrate で自動実行）
  5. Agent出力のJSONブロックをパース → insights.md 自動更新
  6. golden_theory.json 自動更新（チェックリスト追加/棄却移動）
  7. step2_build_model.py 実行（モデル再構築）
  8. 【方法論レビュー】Agent Eの「分析方法の評価」セクションを確認し、
     必要に応じてAgent C/E定義ファイル自体を修正する（下記参照）
  9. 結論レポート生成（analysis_conclusion.md を更新）
```

### サイクル完了後の成果物
サイクルが完了（正常終了・成果あり終了・上限終了のいずれか）すると、以下が更新される:
- `data/output/analysis_conclusion.md` — **分析の最終結論**（誰でも読める形式）
- `data/output/golden_theory.json` — 黄金理論の構造化データ
- `data/history/insights.md` — 採択/棄却の全履歴
- `data/output/model.json` — 統計モデル

## 方法論レビュー（Step 8 詳細）
サイクル完了後、分析方法自体を評価・改善するステップ。
分析結果が出たら、分析方法も疑い、変更を反映する。

### 評価観点
1. **仮説生成の質**: 結果指標を使った仮説が何本あったか？ → 多ければAgent C定義の禁止事項を強化
2. **データの正確性**: Agent Cに事実誤認があったか？ → あればデータ検証プロセスを追加/強化
3. **仮説の多様性**: 同じ方向の仮説ばかりか？ → 偏っていれば思考ガイドラインを修正
4. **棄却パターン**: 全棄却が続くなら、仮説生成の方向性自体が間違っている可能性
5. **Agent E自身の検証品質**: 見逃しや過度に厳しい判定がなかったか

### 改善アクション
- Agent C/E定義ファイル（`agents/analyze-step4-hypothesis.md`, `agents/analyze-step5-verification.md`）を直接編集
- 新たな禁止事項、ガイドライン、データ検証ルールを追加
- 変更内容を `insights.md` の備考に記録

## 差分モード（--diff VIDEO_ID）
- data_summarizer.py --diff VIDEO_ID を実行（step3_analyze.py から自動呼出）
- Agent Cに「この新規動画が既存モデルと矛盾しないか」を重点的に分析させる
- Agent Eで検証
- 矛盾がなければ1サイクルで終了

## ループ制限
- 最大5サイクル
- 5サイクル後も矛盾が残る場合、未解決問題としてindex.mdに記録

## エージェント呼び出し方法
Claude Code の Task ツールで呼び出す:
- Agent C: `agents/analyze-step4-hypothesis.md`
- Agent E: `agents/analyze-step5-verification.md`
