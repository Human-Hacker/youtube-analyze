<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>youtube-analyze ワークフロー v3</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0d1117; color: #c9d1d9; padding: 32px; }
  h1 { text-align: center; font-size: 22px; color: #58a6ff; margin-bottom: 6px; }
  .subtitle { text-align: center; font-size: 13px; color: #8b949e; margin-bottom: 28px; }
  .legend { display: flex; gap: 18px; justify-content: center; margin-bottom: 24px; flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #8b949e; }
  .legend-dot { width: 12px; height: 12px; border-radius: 3px; }
  .container { max-width: 1100px; margin: 0 auto; }

  /* Phase headers */
  .phase { margin-bottom: 28px; }
  .phase-header { font-size: 14px; font-weight: 700; color: #8b949e; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid #21262d; }

  /* Node grid */
  .row { display: flex; gap: 12px; margin-bottom: 12px; align-items: stretch; }
  .node { border-radius: 8px; padding: 14px 16px; flex: 1; min-width: 0; position: relative; }
  .node-title { font-size: 13px; font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
  .node-desc { font-size: 11px; color: #8b949e; line-height: 1.5; }
  .node-files { font-size: 10px; color: #6e7681; margin-top: 6px; font-family: 'SF Mono', monospace; }

  /* Node types */
  .n-config { background: #161b22; border: 1px solid #30363d; }
  .n-python { background: #0d2136; border: 1px solid #1f3a5f; }
  .n-agent  { background: #1a0d2e; border: 1px solid #3b1f6e; }
  .n-data   { background: #0d2818; border: 1px solid #1f5f2e; }
  .n-output { background: #2a1800; border: 1px solid #5f3a00; }
  .n-manual { background: #2d1215; border: 1px solid #5f2328; }
  .n-new    { border-style: dashed !important; border-width: 2px !important; }

  .n-config .node-title { color: #8b949e; }
  .n-python .node-title { color: #58a6ff; }
  .n-agent  .node-title { color: #bc8cff; }
  .n-data   .node-title { color: #3fb950; }
  .n-output .node-title { color: #d29922; }
  .n-manual .node-title { color: #f85149; }

  .badge { font-size: 9px; padding: 1px 5px; border-radius: 3px; font-weight: 600; }
  .badge-new { background: #238636; color: #fff; }
  .badge-mod { background: #9e6a03; color: #fff; }
  .badge-split { background: #1f6feb; color: #fff; }

  /* Arrows */
  .arrow-row { display: flex; justify-content: center; margin: 8px 0; }
  .arrow { color: #30363d; font-size: 20px; }
  .arrow-label { font-size: 10px; color: #6e7681; margin-left: 8px; }

  /* Loop box */
  .loop-box { border: 2px solid #3b1f6e; border-radius: 12px; padding: 16px; margin: 12px 0; position: relative; }
  .loop-label { position: absolute; top: -10px; left: 20px; background: #0d1117; padding: 0 8px; font-size: 11px; color: #bc8cff; font-weight: 700; }

  /* Flow arrow between phases */
  .flow-arrow { text-align: center; padding: 6px 0; }
  .flow-arrow span { display: inline-block; color: #30363d; font-size: 18px; }

  /* Detailed sub-steps */
  .substeps { margin-top: 8px; padding-left: 12px; }
  .substep { font-size: 10px; color: #8b949e; line-height: 1.7; }
  .substep::before { content: '→ '; color: #30363d; }

  /* Data flow sidebar */
  .data-flow { display: flex; gap: 12px; margin-top: 20px; }
  .data-col { flex: 1; }
  .data-col h3 { font-size: 12px; color: #8b949e; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
  .file-item { font-size: 11px; padding: 6px 10px; background: #161b22; border: 1px solid #21262d; border-radius: 4px; margin-bottom: 4px; font-family: 'SF Mono', monospace; display: flex; justify-content: space-between; }
  .file-item .tag { font-size: 9px; color: #6e7681; }

  /* Two-phase agent detail */
  .phase-detail { display: flex; gap: 8px; margin-top: 8px; }
  .phase-block { flex: 1; background: rgba(255,255,255,0.03); border-radius: 4px; padding: 8px; }
  .phase-block-title { font-size: 10px; font-weight: 700; margin-bottom: 4px; }

  .w { width: 100%; }
  .w50 { flex: 0 0 calc(50% - 6px); }
  .w33 { flex: 0 0 calc(33.3% - 8px); }
  .w25 { flex: 0 0 calc(25% - 9px); }
</style>
</head>
<body>
<h1>youtube-analyze ワークフロー v3</h1>
<p class="subtitle">WORKFLOW_IMPROVEMENTS.md（W-1〜W-11）適用後の全体構成</p>

<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:#1f3a5f"></div>Python スクリプト</div>
  <div class="legend-item"><div class="legend-dot" style="background:#3b1f6e"></div>LLM Agent（Claude Code）</div>
  <div class="legend-item"><div class="legend-dot" style="background:#1f5f2e"></div>データファイル</div>
  <div class="legend-item"><div class="legend-dot" style="background:#5f3a00"></div>出力・成果物</div>
  <div class="legend-item"><div class="legend-dot" style="background:#5f2328"></div>手動作業</div>
  <div class="legend-item"><div class="legend-dot" style="background:#238636; border-radius:2px"></div>新規（W-x）</div>
  <div class="legend-item"><div class="legend-dot" style="background:#9e6a03; border-radius:2px"></div>改修（W-x）</div>
</div>

<div class="container">

<!-- ====== CONFIG LAYER ====== -->
<div class="phase">
  <div class="phase-header">設定・知識ベース</div>
  <div class="row">
    <div class="node n-config w25">
      <div class="node-title">config.py</div>
      <div class="node-desc">共通パス・閾値・定数</div>
    </div>
    <div class="node n-config w25">
      <div class="node-title">coordinator.md <span class="badge badge-mod">W-9</span></div>
      <div class="node-desc">分析サイクル仕様書。パス修正 + ループ制御明確化</div>
    </div>
    <div class="node n-config w25">
      <div class="node-title">youtube_fundamentals.md</div>
      <div class="node-desc">前提知識: アルゴリズム + 視聴者心理 + チャンネル固有</div>
    </div>
    <div class="node n-data n-new w25">
      <div class="node-title">golden_theory.json <span class="badge badge-new">W-1</span></div>
      <div class="node-desc">黄金理論二層構造: principles[] + checklist[] + rejected[]</div>
    </div>
  </div>
  <div class="row">
    <div class="node n-python n-new w50">
      <div class="node-title">common/data_loader.py <span class="badge badge-new">W-7</span></div>
      <div class="node-desc">共通データ読み込み: load_all_videos, load_golden_theory, load_insights 等</div>
    </div>
    <div class="node n-python n-new w50">
      <div class="node-title">common/metrics.py <span class="badge badge-new">W-8</span></div>
      <div class="node-desc">共通指標計算: compute_derived_metrics, classify_hit_miss, classify_growth_pattern</div>
    </div>
  </div>
</div>

<div class="flow-arrow"><span>▼</span></div>

<!-- ====== STEP 1 ====== -->
<div class="phase">
  <div class="phase-header">Step 1 — データ取得</div>
  <div class="row">
    <div class="node n-python w50">
      <div class="node-title">step1_auth.py</div>
      <div class="node-desc">OAuth認証</div>
    </div>
    <div class="node n-python w50">
      <div class="node-title">step1_fetch.py</div>
      <div class="node-desc">YouTube API取得 + CSVマージ。--force-refetch, --merge, Day別×トラフィックソースクロス集計, 関連動画ソース詳細</div>
    </div>
  </div>
  <div class="row">
    <div class="node n-data w33">
      <div class="node-title">data/videos/*.json</div>
      <div class="node-desc">24本の動画データ（analytics + manual + script_analysis + daily_data + traffic_breakdown）</div>
    </div>
    <div class="node n-data w33">
      <div class="node-title">data/scripts/*.json</div>
      <div class="node-desc">24本の台本構造分析</div>
    </div>
    <div class="node n-data w33">
      <div class="node-title">data/video_index.json <span class="badge badge-mod">W-10</span></div>
      <div class="node-desc">24本マスタインデックス（11本の幽霊エントリ削除済み）</div>
    </div>
  </div>
</div>

<div class="flow-arrow"><span>▼</span></div>

<!-- ====== STEP 2 ====== -->
<div class="phase">
  <div class="phase-header">Step 2 — 分析サイクル（仮説生成→検証ループ）</div>

  <!-- Phase 1: データ準備 -->
  <div class="row">
    <div class="node n-python w">
      <div class="node-title">step2_analyze.py <span class="badge badge-mod">W-2</span> — Phase 1: データ準備（自動）</div>
      <div class="node-desc">data_summarizer.py を呼び出し → workspace準備 → Agent実行指示を表示</div>
      <div class="substeps">
        <div class="substep">data_summarizer.py 実行 → data_summary.md 生成（§1-13: 概要テーブル〜関連動画ソース）</div>
        <div class="substep">CLI: <code>python step2_analyze.py</code> / <code>--diff VIDEO_ID</code></div>
      </div>
    </div>
  </div>

  <div class="flow-arrow"><span>▼</span> <span class="arrow-label">一旦停止。以下のループをClaude Codeで手動実行</span></div>

  <!-- Loop box -->
  <div class="loop-box">
    <div class="loop-label">仮説生成→検証ループ（最大5サイクル）</div>

    <!-- Agent C -->
    <div class="row">
      <div class="node n-agent w">
        <div class="node-title">Agent C: メタ分析 <span class="badge badge-mod">W-4</span> <span class="badge badge-mod">W-11</span></div>
        <div class="node-desc">水平思考 × 第一原理 × 仮説駆動で新仮説を生成。2フェーズ読み込み + 6ステップ分析フロー</div>
        <div class="phase-detail">
          <div class="phase-block">
            <div class="phase-block-title" style="color:#3fb950">Phase 1: 概要読み込み（必須）</div>
            <div class="substep">data_summary.md（地図）</div>
            <div class="substep">insights.md（蓄積知見）</div>
            <div class="substep">golden_theory.json（現在の理論）</div>
            <div class="substep">model.json + index.md</div>
          </div>
          <div class="phase-block">
            <div class="phase-block-title" style="color:#d29922">⓪ 読み込み計画</div>
            <div class="substep">注目動画を最大8本選定</div>
            <div class="substep">必要データ種別を判断</div>
            <div class="substep">読み込み理由を明示</div>
            <div class="substep" style="color:#6e7681">※初回は全件scan</div>
          </div>
          <div class="phase-block">
            <div class="phase-block-title" style="color:#58a6ff">Phase 2: 選択的深掘り</div>
            <div class="substep">videos/{id}.json（選定分のみ）</div>
            <div class="substep">scripts/{id}.json（必要時のみ）</div>
            <div class="substep">human_scores.json（必要時のみ）</div>
          </div>
        </div>
        <div class="substeps">
          <div class="substep">①共通点抽出 → ②前提列挙 → ③前提反転 → ④仮説生成 → ⑤提示</div>
          <div class="substep">出力: Markdown（人間用）+ JSONブロック（機械パース用）を同一ファイルに共存</div>
        </div>
        <div class="node-files">→ data/workspace/new_hypotheses.md</div>
      </div>
    </div>

    <div class="flow-arrow"><span>▼</span></div>

    <!-- Agent E -->
    <div class="row">
      <div class="node n-agent w">
        <div class="node-title">Agent E: 検証（レッドチーム） <span class="badge badge-mod">W-5</span></div>
        <div class="node-desc">Agent Cの仮説をdata_summary.mdで全件スクリーニング。反例候補のみvideos/*.jsonで詳細確認。確証バイアス防止 + アンカリング防止。3状態判定（支持/修正/棄却）</div>
        <div class="substeps">
          <div class="substep">検証結果 + チェックリスト提案 + 原則更新 + 残存矛盾 + 探索的発見</div>
          <div class="substep">出力: Markdown + JSONブロック（step2がパース）</div>
        </div>
        <div class="node-files">→ data/workspace/verification_report.md</div>
      </div>
    </div>

    <div class="flow-arrow"><span>▼</span> <span class="arrow-label">矛盾残存 & サイクル &lt; 5 → ループ先頭へ</span></div>
  </div>

  <div class="flow-arrow"><span>▼</span> <span class="arrow-label">ループ完了後</span></div>

  <!-- Phase 3: 統合 -->
  <div class="row">
    <div class="node n-python w">
      <div class="node-title">step2_analyze.py --integrate <span class="badge badge-mod">W-2</span> — Phase 3: 統合処理（自動）</div>
      <div class="node-desc">Agent出力のJSONブロックをパースし、insights.md・golden_theory.json を更新 → step3を実行</div>
      <div class="substeps">
        <div class="substep">parse_agent_c_output() → 仮説リスト抽出</div>
        <div class="substep">parse_agent_e_output() → 検証結果・チェックリスト提案・残存矛盾 抽出</div>
        <div class="substep">update_insights() → insights.md に採択/棄却/学び/探索的発見を追記</div>
        <div class="substep">update_golden_theory() → golden_theory.json にチェックリスト追加/棄却移動</div>
        <div class="substep">run_step3() → step3_build_model.py を実行（モデル再構築）</div>
        <div class="substep">矛盾残存チェック → 次サイクル要否を判定</div>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top: 8px;">
    <div class="node n-data w50">
      <div class="node-title">insights.md <span class="badge badge-mod">W-3</span></div>
      <div class="node-desc">YAML frontmatter + 構造化Markdown。採択済みインサイト / 棄却仮説と学び / 未解決の問い / 探索的発見</div>
    </div>
    <div class="node n-data n-new w50">
      <div class="node-title">golden_theory.json <span class="badge badge-new">W-1</span></div>
      <div class="node-desc">更新: チェックリスト追加・棄却条件移動・充足率再計算・discriminative_power再判定</div>
    </div>
  </div>
</div>

<div class="flow-arrow"><span>▼</span></div>

<!-- ====== STEP 3 ====== -->
<div class="phase">
  <div class="phase-header">Step 3 — モデル構築 <span class="badge badge-split">W-6 分割</span></div>
  <div class="row">
    <div class="node n-python w">
      <div class="node-title">step3_build_model.py <span class="badge badge-mod">W-6</span> — エントリーポイント</div>
      <div class="node-desc">common/* → 黄金理論読み込み → フィルタ → パターン → 黄金理論検証 → モデル生成 → レポート → 履歴</div>
    </div>
  </div>
  <div class="row">
    <div class="node n-python w25">
      <div class="node-title">step3_filters.py <span class="badge badge-new">W-6</span></div>
      <div class="node-desc">3段階フィルタ分析（F1/F2/F3）</div>
    </div>
    <div class="node n-python w25">
      <div class="node-title">step3_patterns.py <span class="badge badge-new">W-6</span></div>
      <div class="node-desc">パターン分析・グループ比較・ベンチマーク</div>
    </div>
    <div class="node n-python w25">
      <div class="node-title">step3_report.py <span class="badge badge-new">W-6</span></div>
      <div class="node-desc">Markdownレポート生成</div>
    </div>
    <div class="node n-python w25">
      <div class="node-title">step3_history.py <span class="badge badge-new">W-6</span></div>
      <div class="node-desc">バージョン管理・履歴保存</div>
    </div>
  </div>
  <div class="row" style="margin-top: 8px;">
    <div class="node n-output w33">
      <div class="node-title">model.json</div>
      <div class="node-desc">統合モデル（GI×CA + 黄金理論チェックリスト検証結果）</div>
    </div>
    <div class="node n-output w33">
      <div class="node-title">analysis_report.md</div>
      <div class="node-desc">分析レポート</div>
    </div>
    <div class="node n-output w33">
      <div class="node-title">analysis_history/v{X.X}_{date}/</div>
      <div class="node-desc">スナップショット保存 + index.md更新</div>
    </div>
  </div>
</div>

<div class="flow-arrow"><span>▼</span></div>

<!-- ====== STEP 4 ====== -->
<div class="phase">
  <div class="phase-header">Step 4 — PDCA評価（新動画公開時）</div>
  <div class="row">
    <div class="node n-python w50">
      <div class="node-title">step4_pdca.py</div>
      <div class="node-desc">新動画をモデルで評価。予測 vs 実績を比較</div>
    </div>
    <div class="node n-manual w50">
      <div class="node-title">手動: GI×CA人間評価</div>
      <div class="node-desc">新動画のGI_v3・CAを人間が評価 → human_scores.json更新</div>
    </div>
  </div>
</div>

<!-- ====== DATA FLOW ====== -->
<div class="phase" style="margin-top: 32px;">
  <div class="phase-header">データフロー概要</div>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
    <div>
      <h3 style="font-size: 12px; color: #58a6ff; margin-bottom: 8px;">Python → ファイル</h3>
      <div class="file-item">step1_fetch.py → videos/*.json <span class="tag">API data</span></div>
      <div class="file-item">data_summarizer.py → data_summary.md <span class="tag">概要</span></div>
      <div class="file-item">step2 --integrate → insights.md <span class="tag">W-2</span></div>
      <div class="file-item">step2 --integrate → golden_theory.json <span class="tag">W-2</span></div>
      <div class="file-item">step3 → model.json + report + history <span class="tag">W-6</span></div>
    </div>
    <div>
      <h3 style="font-size: 12px; color: #bc8cff; margin-bottom: 8px;">Agent → ファイル</h3>
      <div class="file-item">Agent C → new_hypotheses.md <span class="tag">MD + JSON</span></div>
      <div class="file-item">Agent E → verification_report.md <span class="tag">MD + JSON</span></div>
      <div class="file-item" style="border-color: #3b1f6e;">Agent C ← data_summary.md + insights + theory <span class="tag">Phase 1</span></div>
      <div class="file-item" style="border-color: #3b1f6e;">Agent C ← videos/{選定分}.json <span class="tag">Phase 2</span></div>
      <div class="file-item" style="border-color: #3b1f6e;">Agent E ← data_summary.md（全件scan） <span class="tag">検証</span></div>
    </div>
  </div>
</div>

<!-- ====== CLI REFERENCE ====== -->
<div class="phase" style="margin-top: 20px;">
  <div class="phase-header">CLIリファレンス</div>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
    <div class="file-item">python step1_fetch.py --force-refetch <span class="tag">全件API再取得</span></div>
    <div class="file-item">python step1_fetch.py --merge <span class="tag">取得 + CSV統合</span></div>
    <div class="file-item">python step2_analyze.py <span class="tag">Phase 1: データ準備</span></div>
    <div class="file-item">python step2_analyze.py --diff VID <span class="tag">差分分析</span></div>
    <div class="file-item">python step2_analyze.py --integrate <span class="tag">Phase 3: 統合</span></div>
    <div class="file-item">python step3_build_model.py <span class="tag">モデル再構築</span></div>
    <div class="file-item">python step4_pdca.py VIDEO_ID <span class="tag">PDCA評価</span></div>
    <div class="file-item">python data_summarizer.py --diff VID <span class="tag">差分要約</span></div>
  </div>
</div>

</div>
</body>
</html>
